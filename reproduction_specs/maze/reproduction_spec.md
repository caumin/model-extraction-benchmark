# REPRODUCTION SPECIFICATION
**Target:** MAZE: Data-Free Model Stealing Attack Using Zeroth-Order Gradient Estimation
**Status:** PENDING REFACTORING

## 1. Global Constants & Configuration Map
*Define the exact variable values mandated by the paper. The Coding Agent must enforce these.*

| Paper Symbol | Description | Required Value/Constraint | Current Code Var | Action |
| :--- | :--- | :--- | :--- | :--- |
| $B$ | Batch size | `128` | `mebench/attackers/maze.py:26` | **NO CHANGE** |
| $N_G$ | Generator steps | `1` | `mebench/attackers/maze.py:29` | **NO CHANGE** |
| $N_C$ | Clone steps | `5` | `mebench/attackers/maze.py:30` | **NO CHANGE** |
| $N_R$ | Replay steps | `10` | `mebench/attackers/maze.py:31` | **NO CHANGE** |
| $m$ | Random directions | `10` | `mebench/attackers/maze.py:32` | **NO CHANGE** |
| $\epsilon$ | Forward-diff step | `1e-3` | `mebench/attackers/maze.py:33` | **NO CHANGE** |
| $\eta_C$ | Clone LR (SGD) | `0.1` | `mebench/attackers/maze.py:27` | **NO CHANGE** |
| $\eta_G$ | Generator LR (SGD) | `1e-4` | `mebench/attackers/maze.py:28` | **NO CHANGE** |
| $L_C$ | Clone loss | $D_{KL}(\tilde{y}_T || \tilde{y}_C)$ | `mebench/attackers/maze.py:299-304` | **VERIFY** |
| $L_G$ | Generator loss | $-D_{KL}(\tilde{y}_T || \tilde{y}_C)$ | `mebench/attackers/maze.py:332-356` | **VERIFY** |
| $\nabla_{FWD}$ | ZO grad | $\frac{d}{m}\sum_i \frac{L(x+\epsilon u_i)-L(x)}{\epsilon}u_i$ | `mebench/attackers/maze.py:340-366` | **VERIFY** |
| $R$ | Replay buffer size | `5000` | `mebench/attackers/maze.py:35` | **NO CHANGE** |

## 2. Threat Model Constraints (Hard Blockers)
*List operations that are FORBIDDEN by the paper's threat model.*
* **Forbidden:** Hard-label victim outputs for MAZE gradient estimation.
* **Allowed:** Soft probability outputs only.
* **Enforcement:** Raise error if `oracle_output.kind != soft_prob`.

## 3. Refactoring Tasks (Logic Corrections)
*Break down logic errors into discrete, implementable tasks.*

### [TASK-001] Remove Noise Padding in Proposal
* **Target Function:** `mebench/attackers/maze.py:_select_query_batch()`
* **Paper Reference:** Algorithm 1 (queries should be generated by G)
* **Defect:** Pads with random noise when `k` is small.
* **Required Logic:**
    * Return partial batch without noise padding; carry remainder to next call.

### [TASK-002] Enforce Generator Architecture Fidelity
* **Target Function:** `mebench/attackers/maze.py:_create_generator()`
* **Paper Reference:** Section 4.5 (3-layer conv + upsampling)
* **Defect:** Uses generic DCGAN without fixed depth.
* **Required Logic:**
    * For 32x32 outputs, force 3-layer generator per paper.

## 4. Verification Assertions
*Boolean checks the agent should run after refactoring.*
1. `assert grad_approx_m == 10 and grad_approx_epsilon == 1e-3`
2. `assert n_g_steps == 1 and n_c_steps == 5 and n_r_steps == 10`
3. `assert oracle_output.kind == "soft_prob"`
4. `assert no_noise_padding_in_propose`
